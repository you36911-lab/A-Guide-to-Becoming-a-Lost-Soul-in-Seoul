const isNewSession = !sessionStorage.getItem("sessionInit");
if (isNewSession) sessionStorage.setItem("sessionInit", "1");

/************ Google Drive Sync (appDataFolder) ************/
const GDRIVE_CLIENT_ID = "675841428134-bdjtlimn587qqgdaiev0pk9a1m42lt9h.apps.googleusercontent.com"; // ‚Üê ÍµêÏ≤¥
const GDRIVE_SCOPES = "https://www.googleapis.com/auth/drive.appdata";
let googleTokenClient = null;
let gapiInited = false;
let gisInited = false;
let driveFileId = null; // cozy-korean.json fileId

window.addEventListener("load", () => {
  gapi.load("client", async () => {
    await gapi.client.init({});
    await gapi.client.load("drive", "v3");
    gapiInited = true;
  });
  google.accounts.id.initialize({ client_id: GDRIVE_CLIENT_ID, callback: () => {} });
  googleTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GDRIVE_CLIENT_ID,
    scope: GDRIVE_SCOPES,
    prompt: "",
    callback: () => {}
  });
  gisInited = true;
});

async function ensureDriveAuth() {
  if (!gapiInited || !gisInited) throw new Error("Google APIs not ready yet");
  if (!gapi.client.getToken()) {
    await new Promise((resolve, reject) => {
      googleTokenClient.callback = (resp) => resp.error ? reject(resp) : resolve(resp);
      googleTokenClient.requestAccessToken();
    });
  }
}

async function ensureCozyFile() {
  if (driveFileId) return driveFileId;
  await ensureDriveAuth();
  const listRes = await gapi.client.drive.files.list({
    spaces: "appDataFolder",
    q: "name = 'cozy-korean.json' and trashed = false",
    fields: "files(id,name)"
  });
  if (listRes.result.files?.length) {
    driveFileId = listRes.result.files[0].id;
    return driveFileId;
  }
  const createRes = await gapi.client.drive.files.create({
    resource: { name: "cozy-korean.json", parents: ["appDataFolder"] },
    media: { mimeType: "application/json", body: JSON.stringify({ createdAt: new Date().toISOString() }) },
    fields: "id"
  });
  driveFileId = createRes.result.id;
  return driveFileId;
}

async function driveSaveState(stateObj) {
  const fileId = await ensureCozyFile();
  await ensureDriveAuth();
  await gapi.client.request({
    path: `/upload/drive/v3/files/${fileId}`,
    method: "PATCH",
    params: { uploadType: "media" },
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(stateObj)
  });
  return true;
}

async function driveLoadState() {
  const fileId = await ensureCozyFile();
  await ensureDriveAuth();
  const res = await gapi.client.drive.files.get({ fileId, alt: "media" });
  const data = typeof res.body === "string" ? JSON.parse(res.body) : (res.result || res);
  return data || {};
}

function driveSignOut() {
  const token = gapi.client.getToken();
  if (token) {
    google.accounts.oauth2.revoke(token.access_token);
    gapi.client.setToken("");
  }
  driveFileId = null;
}

// Î©îÏù∏ÌÉ≠ active ÌëúÏãúÏö©
function setActiveTabUI(containerEl, activeTab) {
  const tabs = containerEl.querySelectorAll(".tab");
  tabs.forEach(t => {
    const isActive = t.textContent.trim() === activeTab;
    t.classList.toggle("active", isActive);
  });
}

// renderer.js ÏµúÏÉÅÎã® DOMContentLoaded Í∑ºÏ≤òÏóê Ï∂îÍ∞Ä
if (navigator.storage && navigator.storage.persist) {
  navigator.storage.persist().then(granted => {
    console.log(granted ? "Persistent storage granted" : "Persistent storage not granted");
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // Í∏∞Ï°¥ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Îç∞Ïù¥ÌÑ∞ ÏùΩÍ∏∞
  const savedName = localStorage.getItem("username");
  const savedLevel = localStorage.getItem("level");

  // Ï≤´ Î∞©Î¨∏: Î°úÏª¨Ïóê Ïù¥Î¶ÑÏù¥ ÏóÜÏúºÎ©¥ Í≥ßÎ∞îÎ°ú Ïù¥Î¶Ñ ÏûÖÎ†• ÌôîÎ©¥ÏúºÎ°ú
if (!savedName) {
  renderNameInput();
  return;
}

  // 2) ‚òÖ ÏÉà ÏÑ∏ÏÖòÏù¥Î©¥: Ïù¥Ï†Ñ state Î¨¥ÏãúÌïòÍ≥† ÌÉÄÏù¥ÌãÄ Î≥¥Ïó¨Ï£ºÍ∏∞
  if (isNewSession) {
    const titleStartBtn = document.getElementById("startBtn");
    const titleJoinBtn = document.getElementById("joinBtn");

    // Start ÎàåÎ†ÄÏùÑ Îïå, ÏÇ¨Ïö©Ïûê ÏßÑÌñâÏÉÅÌÉúÏóê Îî∞Îùº Îã§Ïùå ÌôîÎ©¥
    if (titleStartBtn) titleStartBtn.addEventListener("click", () => {
      if (savedName && savedLevel) return showMainAppScreen();
      if (savedName && !savedLevel) return showLevelSelection();
      return renderNameInput();
    });
    if (titleJoinBtn) titleJoinBtn.addEventListener("click", showMembershipPage);

    saveAppState("title"); // ÌòÑÏû¨ ÌôîÎ©¥ Í∏∞Î°ù
    return; // ‚Üê Ï§ëÏöî: Î≥µÏõê Î°úÏßÅÏúºÎ°ú ÎÇ¥Î†§Í∞ÄÏßÄ ÏïäÍ≤å
  }

  const state = loadAppState();
  // 1) ÏÉÅÌÉúÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† Î≥µÏõê
  if (state.page) {
    switch (state.page) {
        case "myCornerPanel":
        openMyCornerPanel();
        return;
      case "mainLearning":
        showMainLearningScreen((state.tab || "Home"));
        return;
      case "mainApp":
        showMainAppScreen();
        return;
      case "levelSelection":
        showLevelSelection();
        return;
      case "membershipCompare":
        showMembershipPage();
        return;
      case "membershipPayment":
        showMembershipPaymentPage();
        return;
      case "placementIntro":
        showPlacementIntro();
        return;
      case "placementTest":
        // ÏßÑÌñâ Ï§ëÏù¥Îçò ÌÖåÏä§Ìä∏ Î≥µÏõê
        startPlacementTest(state.testState || null); 
        return;
      case "placementResult":
        showPlacementResult(state.recommendedLevel || "A1");
        return;
      case "nameInput":
        renderNameInput();
        return;
      case "title": {
  const titleStartBtn = document.getElementById("startBtn");
  const titleJoinBtn = document.getElementById("joinBtn");
  if (titleStartBtn) titleStartBtn.addEventListener("click", () => {
    if (savedName && savedLevel) return showMainAppScreen();
    if (savedName && !savedLevel) return showLevelSelection();
    return renderNameInput();
  });
if (titleJoinBtn) titleJoinBtn.addEventListener("click", showMembershipPage);
return;
  }
}
  }

// 2) ÏÉÅÌÉú ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Î°úÏßÅ + ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÏÉÅÌÉú Ï†ÄÏû•
if (savedName && savedLevel) {
    const titleStartBtn = document.getElementById("startBtn");
    const titleJoinBtn = document.getElementById("joinBtn");
    if (titleStartBtn) titleStartBtn.addEventListener("click", () => { showMainLearningScreen(); });
    if (titleJoinBtn) titleJoinBtn.addEventListener("click", showMembershipPage);
    saveAppState("title");
    return;
  }

  if (savedName && !savedLevel) {
    showLevelSelection();
  } else {
    renderNameInput();
  }
});

function renderNameInput() {
  saveAppState("nameInput");
  const frameBox = document.querySelector(".frame-box");
  clearMembershipFrame();
  frameBox.innerHTML = `
    <h2>A Guide<br>to Becoming<br>a Lost Soul in Seoul</h2>
    <p class="description">Welcome, wanderer. This app is your cozy guide to learning Korean.</p>
    <input type="text" id="username" name="username" placeholder="Enter your name" />
    <div class="buttons">
      <button class="btn" id="startBtn">Start Learning</button>
      <button class="btn secondary" id="joinBtn">Join Our Secret Society</button>
    </div>
    <p class="credit">Made by Sooya with üíñ</p>
  `;

  document.getElementById("startBtn").addEventListener("click", () => {
    const username = document.getElementById("username").value.trim();
    if (!username) {
      alert("Please enter your name!");
    } else {
      localStorage.setItem("username", username);
      localStorage.setItem("firstVisit", "true");
      showLevelSelection();
    }
  });

  document.getElementById("joinBtn").addEventListener("click", showMembershipPage);
  mountButterflies();
}

function showLevelSelection() {
  saveAppState("levelSelection");
  const frameBox = document.querySelector(".frame-box");
  const username = localStorage.getItem("username");

  frameBox.innerHTML = `
    <h2 class="choose-level">Choose Your Level</h2>
    <p class="description">Hi ${username}! Let's begin where you're comfortable.</p>
    <div class="level-buttons">
      ${["A0", "A1", "A2", "B1", "B2", "C1"].map(level => `<button class="btn level">${level}</button>`).join("")}
    </div>
    <p class="beginner">Please choose A0 if you're a complete beginner without any Korean knowledge.</p>
    <button class="btn test">Would you like to take a placement test?</button>
  `;

  document.querySelectorAll(".btn.level").forEach(button => {
    button.addEventListener("click", () => {
      localStorage.setItem("level", button.textContent);
      showMainAppScreen();
    });
  });
}

function showMainAppScreen() {
  saveAppState("mainApp");
  const frameBox = document.querySelector(".frame-box");
  const name = localStorage.getItem("username");
  const level = localStorage.getItem("level");

  frameBox.innerHTML = `
    <h2 class="welcome">Welcome, ${name}!</h2>
    <p class="description">You're currently studying at <strong>Level ${level}</strong>.</p>
    <div class="buttons" style="margin-top: 2rem;">
      <button class="btn">Start Learning</button>
      <button class="btn secondary change-level">Change Level</button>
    </div>
  `;

  document.querySelector(".btn").addEventListener("click", () => showMainLearningScreen("Home"));
  document.querySelector(".change-level").addEventListener("click", () => {
    localStorage.removeItem("level");
    localStorage.setItem("firstVisit", "true");
    showLevelSelection();
  });
}

function showMainLearningScreen(initialTab = "Home") {
  if (typeof initialTab !== "string") initialTab = "Home";
  saveAppState("mainLearning", { tab: initialTab });
  // ÌÉ≠ Î∞î ÏÉùÏÑ±
  const tabBarWrapper = document.createElement("div");
  tabBarWrapper.classList.add("tab-bar-wrapper");
  tabBarWrapper.innerHTML = `
    <div class="tab-bar">
      <div class="tab-group">
        <div class="tab active">Home</div>
        <div class="tab">Reading</div>
        <div class="tab">Listening</div>
        <div class="tab">Writing</div>
        <div class="tab">Speaking</div>
        <div class="tab">Grammar+</div>
        <div class="tab">Vocabulary+</div>
      </div>
     <button class="my-corner">My Corner</button>
    </div>
  `;

  // frame-box ÏÉùÏÑ±
  const frameBox = document.createElement("div");
  frameBox.classList.add("main-screen");
  frameBox.innerHTML = `
    <div class="main-header">
    </div>
      
    <div class="tab-content" id="tabContent"></div>
  `;

  // 3. ÎëòÏùÑ Í∞êÏã∏Îäî Í∑∏Î£π ÎßåÎì§Í∏∞
  const tabAndFrameContainer = document.createElement("div");
  tabAndFrameContainer.classList.add("tab-and-frame-container");
  tabAndFrameContainer.appendChild(tabBarWrapper);
  tabAndFrameContainer.appendChild(frameBox);

  // 4. backgroundÏóê Î∂ôÏù¥Í∏∞
  const background = document.querySelector(".background");
  background.innerHTML = "";
  background.appendChild(tabAndFrameContainer);

  // ÌÉ≠ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
  const tabs = tabBarWrapper.querySelectorAll(".tab");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      saveAppState("mainLearning", { tab: tab.textContent.trim() });
      updateTabContent(tab.textContent.trim());
    });
  });

  // My Corner ‚Üí Í∞ôÏùÄ ÌîÑÎ†àÏûÑ(#tabContent)Ïóê ÏÑ∏ÌåÖ ÌôîÎ©¥ Î†åÎçî
const myCornerBtn = tabBarWrapper.querySelector(".my-corner");
if (myCornerBtn) {
  myCornerBtn.addEventListener("click", () => {
    const prevTab = (loadAppState().tab) || "Home"; // ÌòÑÏû¨ ÌÉ≠ Í∏∞Ïñµ
    saveAppState("myCornerPanel", { lastTab: prevTab });
    openMyCornerPanel(); // Í∞ôÏùÄ ÌîÑÎ†àÏûÑÏóê Ìå®ÎÑê Î†åÎçî
  });
}

  // Ï†ÄÏû•Îêú ÌÉ≠ Î∞òÏòÅ
  setActiveTabUI(tabBarWrapper, initialTab);
  updateTabContent(initialTab);
}

function updateTabContent(tab) {
  saveAppState("mainLearning", { tab });
  const state = loadAppState();
  const tabContent = document.getElementById("tabContent");
  const level = localStorage.getItem("level");
  const username = localStorage.getItem("username");
  const weeklyMessage = "üì£ Weekly News: You can now unlock Cozy Study Corner items with quiz streaks!";

   const cheerUps = [
    "<span class='korean ko-first'>ÌèâÏÉùÏÜåÏõêÏù¥ ÎàÑÎ£ΩÏßÄüçö</span><br>A lifelong wish as humble as scorched rice.",
    "<span class='korean ko-first'>Ïó¥ Í∏∏ Î¨ºÏÜçÏùÄ ÏïåÏïÑÎèÑ Ìïú Í∏∏ ÏÇ¨ÎûåÏùò ÏÜçÏùÄ Î™®Î•∏Îã§üß†</span><br>You may fathom deep water, but never a person's mind.",
    "<span class='korean ko-first'>ÌÜ†ÎÅº ÏûÖÏóê ÏΩ©Í∞ÄÎ£® Î®πÏùÄ Í≤É Í∞ôÎã§üêá</span><br>Someone has food traces around their mouth, like a rabbit with bean powder around its mouth.",
    "<span class='korean ko-first'>ÏãùÌòú Î®πÏùÄ Í≥†ÏñëÏù¥ ÏÜçüßã</span><br>Like a guilty cat afraid its misdeed will be found out.",
    "<span class='korean ko-first'>ÎπåÎ†§ Ïò® Í≥†ÏñëÏù¥Í∞ôÏù¥üêà</span><br>Sitting quietly in a room full of chatter, like a borrowed cat that doesn‚Äôt quite belong.",
    "<span class='korean ko-first'>Í≤ÄÏùÄ Í≥†ÏñëÏù¥ Îàà Í∞êÏùÄ ÎìØüêà‚Äç‚¨õ</span><br>Hard to tell things apart, like trying to tell if a black cat's eyes are open or shut.",
    "<span class='korean ko-first'>Íµ¨Ïä¨Ïù¥ ÏÑú ÎßêÏù¥ÎùºÎèÑ Íø∞Ïñ¥Ïïº Î≥¥Î∞∞Îã§ü¶™</span><br>A pearl is worthless as long as it is in it's shell.",
    "<span class='korean ko-first'>ÏÑúÎãπÍ∞ú ÏÇºÎÖÑÏù¥Î©¥ ÌíçÏõîÏùÑ ÏùäÎäîÎã§üêï</span><br>Everybody learns with time.",
    "<span class='korean ko-first'>Í≥†ÏñëÏù¥ Îã¨Í±Ä Íµ¥Î¶¨ÎìØü•ö</span><br>Handling something cleverly and skillfully, like a cat rolling an egg without breaking it.",
    "<span class='korean ko-first'>Ìò∏ÎûëÏù¥ Íµ¥Ïóê Í∞ÄÏïº Ìò∏ÎûëÏù¥Î•º Ïû°ÎäîÎã§üêÖ</span><br>Nothing ventured, nothing gained.",
    "<span class='korean ko-first'>Í≥†ÏñëÏù¥ÌïúÌÖå ÏÉùÏÑ†ÏùÑ Îß°Í∏∞Îã§üêü</span><br>Leaving something with someone untrustworthy, like entrusting fish to a cat.",
    "<span class='korean ko-first'>Í∞ú Íº¨ÎùΩÏÑúÎãà ÎØ∏ÏõåÏÑú ÎÇôÏßÄ ÏÇ∞Îã§üêô</span><br>Doing something just because it annoys the person you dislike.",
    "<span class='korean ko-first'>Í≥†ÏñëÏù¥ Ï•ê ÏÉùÍ∞Åüòø</span><br>Acting as if you care for someone when you clearly don‚Äôt,<br>like a cat pretending to care about a mouse.",
    "<span class='korean ko-first'>ÏõêÏà≠Ïù¥ÎèÑ ÎÇòÎ¨¥ÏóêÏÑú Îñ®Ïñ¥ÏßÑÎã§üêí</span><br>No matter how skilled you are, you still make mistakes sometimes,<br>like a monkey falling from a tree.",
    "<span class='korean ko-first'>ÏõêÏà≠Ïù¥ Îã¨ Ïû°Í∏∞üåô</span><br>Someone overreaching beyond their means and getting harmed,<br>like a monkey drowning while reaching for the moon‚Äôs reflection.",
    "<span class='korean ko-first'>ÌÜ†ÎÅºÍ∞Ä Ï†ú Î∞©Í∑ÄÏóê ÎÜÄÎûÄÎã§üí®</span><br>Being frightened by one‚Äôs own secret misdeed, like a rabbit startled by its own fart.",
    "<span class='korean ko-first'>Í∞úÍµ¨Î¶¨ ÎÇØÏßùÏóê Î¨º Î∂ìÍ∏∞ü´ó</span><br>Like water off a frog‚Äôs face.",
    "<span class='korean ko-first'>Í∞úÍµ¨Î¶¨ Ïò¨Ï±ôÏù¥ Ï†Å ÏÉùÍ∞Å Î™ª ÌïúÎã§üê∏</span><br>After success, forgetting where you came from,<br>like a frog forgetting when it was a tadpole.",
    "<span class='korean ko-first'>ÎèºÏßÄ Î∞úÌÜ±Ïóê Î¥âÏà≠ÏïÑÎ•º Îì§Ïù∏Îã§üê∑</span><br>Overdressing or decorating in a way that doesn‚Äôt suit, like dying a pig's hoof.",
    "<span class='korean ko-first'>Ìå•Ï£Ω Îã®ÏßÄÏóê ÏÉùÏ•ê Îã¨ÎûëÍ±∞Î¶¨ÎìØü•£</span><br>Keep coming back again and again, like a mouse dangling around a jar of red bean porridge.",
    "<span class='korean ko-first'>ÏÉùÏ•ê ÏÜåÍ∏à Î®πÎìØ ÌïúÎã§üßÇ</span><br>Tasting a little, without really eating much, like a mouse nibbling at salt.",
    "<span class='korean ko-first'>ÌïòÎ£ªÍ∞ïÏïÑÏßÄ Î≤î Î¨¥ÏÑúÏö¥ Ï§Ñ Î™®Î•∏Îã§üêØ</span><br>Ignorance makes one bold, like a one-day-old puppy that doesn't know to fear the tiger.",
    "<span class='korean ko-first'>ÏûëÏùÄ Ï†àÏóê Í≥†ÏñëÏù¥Í∞Ä Îëê ÎßàÎ¶¨Îùºüêæ</span><br>Too many for the place, more than needed,<br>like two cats living in a small temple where there‚Äôs hardly any food.",
    "<span class='korean ko-first'>Îò• Î¨ªÏùÄ Í∞úÍ∞Ä Í≤® Î¨ªÏùÄ Í∞ú ÎÇòÎ¨¥ÎûÄÎã§üí©</span><br>Someone with a bigger flaw criticizes another for a much smaller one,<br>like a dog with dung on it scolding a dog with chaff on it.",
    "<span class='korean ko-first'>ÍΩÉ Î≥∏ ÎÇòÎπÑ Î∂àÏùÑ Ìó§ÏïÑÎ¶¨Îû¥ü¶ã</span><br>When love runs deep, a man and woman will risk even death to be together,<br>like butterflies that has spotted a flower.",
    "<span class='korean ko-first'>ÍøÄÎèÑ ÏïΩÏù¥ÎùºÎ©¥ Ïì∞Îã§üçØ</span><br>Even sweet words sound unpleasant when they‚Äôre admonitions directed at oneself,<br>like honey that tastes bitter when it's used as medicine.",
    "<span class='korean ko-first'>ÎØ∏Ïö¥ ÎÜà Îñ° ÌïòÎÇò Îçî Ï§ÄÎã§üç°</span><br>Treat someone you dislike better, so you won't suffer consequences.",
    "<span class='korean ko-first'>Ìñ•Í∏∞Í∞Ä ÏûàÎäî ÍΩÉÏùÄ Í∞ÄÏãú ÎèãÏπú ÎÇòÎ¨¥Ïóê ÌïÄÎã§üåπ</span><br>A fragrant flower blooms on a thorny tree, so value the substance, not the appearance.",
    "<span class='korean ko-first'>ÏÇ¨Ï¥åÏù¥ ÎïÖÏùÑ ÏÇ¨Î©¥ Î∞∞Í∞Ä ÏïÑÌîÑÎã§ü´É</span><br>When a cousin buys land, your stomach aches. Another‚Äôs gain becomes your pain.",
    "<span class='korean ko-first'>ÎπàÎåÄ Ïû°ÏúºÎ†§Í≥† Ï¥àÍ∞ÄÏÇºÍ∞Ñ ÌÉúÏö¥Îã§üõñ</span><br>Burning down the house to kill a bedbug.",
  ];

  const randomMessage = cheerUps[Math.floor(Math.random() * cheerUps.length)].replace("[username]", username);

  if (tab === "Home") {
    tabContent.innerHTML = `
      <div class="main-header-flex">
        <div class="level-indicator">Level ${localStorage.getItem("level")}</div>
        <h2 class="hi">{ <span class="korean">Î∞òÍ∞ÄÏõåÏöî</span>, ${username}! }</h2>
      </div>
      <p class="cheer-message">${randomMessage}</p>
      <div class="weekly-banner">${weeklyMessage}</div>
    `;
  } else if (["Reading", "Listening", "Writing", "Speaking"].includes(tab)) {
    tabContent.innerHTML = `
      <div class="learning-frame" style="display: flex; gap: 2rem;">
        <div class="main-section" style="flex: 2;">
          ${getLevelSpecificContent(tab, level)}
        </div>
        <div class="dict-column">
          <h3>üìö KRDict Quick Search</h3>
          <div class="dict-input-wrapper">
            <input class="input-row" id="krdictSearch" type="text" placeholder="Search a word..." />
            <button id="krdictGo" class="input-button input-row">üîç</button>
            <p>
              üî∏ The word you enter will open in a new window<br>
              on the <strong>KRDict</strong> website.<br>
              üî∏ This feature uses text-based content from
              <a href="https://krdict.korean.go.kr" target="_blank">KRDict</a><br>
              üî∏ ¬© National Institute of Korean Language<br>
              üî∏ Licensed under <strong>CC BY-SA 2.0 KR</strong>
            </p>
          </div>
        </div>
      </div>
    `;

   setTimeout(() => {
    const input = document.getElementById("krdictSearch");
    const btn = document.getElementById("krdictGo");

    if (!input || !btn) return;

    const openKRDictExternal = (rawTerm) => {
      const term = (rawTerm || "").trim();
      if (!term) return;

      const url = `https://krdict.korean.go.kr/eng/dicMarinerSearch/search?nation=eng&nationCode=6&ParaWordNo=&mainSearchWord=${encodeURIComponent(term)}`;
      window.open(url, "_blank", "noopener");
    };

    const go = () => openKRDictExternal(input.value);

    btn.addEventListener("click", go);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") go();
    });
  }, 0);

  } else if (tab === "Grammar+") {
  tabContent.innerHTML = `
    <div class="learning-frame" style="display: flex;">
      <div class="main-section" style="flex: 1;">
        ${getLevelSpecificContent(tab, level)}
      </div>
    </div>
  `;
}
  else if (tab === "Vocabulary+") {
    tabContent.innerHTML = `
    <div class="learning-frame" style="display: flex;">
      <div class="main-section" style="flex: 1;">
        ${getLevelSpecificContent(tab, level)}
      </div>
    </div>
  `;
  }
}

function getLevelSpecificContent(section, level) {
  return `
    <p><strong>${section} - Level ${level}</strong></p>
    <p style="margin-top: 1rem;">üìù Content for ${section} at ${level} level coming soon...</p>
  `;
}

// Î©§Î≤ÑÏã≠ ÎπÑÍµê ÌéòÏù¥ÏßÄ
function showMembershipPage() {
  saveAppState("membershipCompare");
  const frameBox = document.querySelector(".frame-box");
  frameBox.classList.add("membership-frame");
  frameBox.innerHTML = `
    <div class="membership-comparison">
      <div class="column mem-col">
        <h3>üåø Free Version</h3>
        <ul>
          <li>üå± Basic grammar tips in each lesson</li>
          <li>üå± Unlock a few Cozy Corner items by completing levels or quizzes</li>
          <li>üå± Limited customizations through achievements</li>
          <li>üå± No access to Korean proverbs or idioms</li>
        </ul>
      </div>
      <div class="column mem-col">
        <h3>üå∏ Membership</h3>
        <ul>
          <li>üìò Full grammar explanations with examples by level</li>
          <li>üî§ Full vocabulary lists by level</li>
          <li>üè° Full My Corner experience with exclusive items</li>
          <li>ü™∑ Explore proverbs, idioms & a little bit of Hanja</li>
        </ul>
      </div>
    </div>
    <div class="join-now-wrapper">
      <img src="joinnow.png" alt="Join Now Arrows" class="join-decor" />
      <button class="btn highlight">Join Now</button>
    </div>
    <div class="buttons" style="margin-top: 0;">
      <button class="btn secondary small-go memgb">Go Back</button>
    </div>
  `;

   document.querySelector('.small-go').addEventListener('click', () => {
    const name = localStorage.getItem("username");
    const level = localStorage.getItem("level");
    if (level) return showMainAppScreen();
    if (name) return showLevelSelection();
    return renderNameInput();
  });

  document.querySelector('.highlight').addEventListener('click', () => {
    showMembershipPaymentPage();
  });
}

function clearMembershipFrame() {
  document.querySelector(".frame-box")?.classList.remove("membership-frame");
}

function showMembershipPaymentPage() {
  saveAppState("membershipPayment");
  const frameBox = document.querySelector(".frame-box");
  clearMembershipFrame();
  frameBox.innerHTML = `
    <h2 class="c-p">Choose Your Plan</h2>
    <p class="description">Select your membership plan and payment methodüíñ</p>

    <div class="plan-options">
      <label><input type="radio" name="plan" value="monthly" checked /> $4.99 / month</label><br/>
      <label><input type="radio" name="plan" value="yearly" /> $39.99 / year</label>
    </div>

    <div class="payment-options" style="margin-top: 1.5rem;">
      <button class="btn" id="payWithCard">Pay with Card</button>
      <button class="btn secondary" id="payWithPaypal">Pay with PayPal</button>
    </div>

    <div class="buttons" style="margin-top: 2rem;">
      <button class="btn secondary small-go">Go Back</button>
    </div>
  `;

  document.querySelector(".small-go").addEventListener("click", showMembershipPage);

  document.getElementById("payWithCard").addEventListener("click", () => {
    alert("Card payments are not set up yet. Please use PayPal for now üôè");
  });

  document.getElementById("payWithPaypal").addEventListener("click", () => {
    const selectedPlan = document.querySelector('input[name="plan"]:checked').value;
    const paypalURL = selectedPlan === "monthly"
      ? ""
      : "";

    window.open(paypalURL, "_blank");
  });
}

function showPlacementIntro() {
  saveAppState("placementIntro");
  const frameBox = document.querySelector(".frame-box");
  frameBox.innerHTML = `
    <h2 class="p-t">Placement Test</h2>
    <p class="description">We'll help you find your perfect starting level.<br>
    The questions will get harder as you go. If it gets too tricky, don't worry.<br>We'll stop and recommend the best level for you.</p>
    <div class="buttons place-b">
      <button class="btn" id="startPlacementBtn">Start Test</button>
      <button class="btn secondary other-gb">Go Back</button>
    </div>
  `;

  document.querySelector(".other-gb").addEventListener("click", showLevelSelection);
  document.getElementById("startPlacementBtn").addEventListener("click", () => {
    startPlacementTest();
  });
}

const PL_LEVELS = ["A0", "A1", "A2", "B1", "B2", "C1"];

function startPlacementTest(restoredState = null) {
  saveAppState("placementTest", { testState: restoredState || null });
  const frameBox = document.querySelector(".frame-box");

  const testState = restoredState || {
    currentLevelIndex: 0,
    correctCount: 0,
    questionIndex: 0,
    globalIndex: 0
  };

  // ÏûÑÏãú ÏßàÎ¨∏ (ÎÇòÏ§ëÏóê Î¨∏Ï†ú DB Ï∂îÍ∞Ä ÏòàÏ†ï)
  const questions = {
    A1: [
      { question: "Choose the grammatically correct sentence.", options: ["<span class='korean'>Ï†ÄÎäî ÌïôÍµêÏóê Í∞ÄÏöî</span>", "<span class='korean'>ÌïôÍµêÏóê Í∞ÄÏöî Ï†ÄÎäî</span>", "<span class='korean'>Í∞ÄÏöî Ï†ÄÎäî ÌïôÍµêÏóê</span>", "<span class='korean'>ÌïôÍµê Í∞ÄÏöî Ï†ÄÎäîÏóê</span>"], answer: 0 },
      { question: "What does ‚Äú<span class='korean ko-size'>ÌïôÍµêÏóê Í∞ÄÏöî</span>‚Äù mean?", options: ["I study at school", "I go to school", "I come back from school", "I like school"], answer: 1 },
      { question: "Choose the grammatically correct sentence.", options: ["<span class='korean'>ÌïôÏÉùÏùÄ Ï±ÖÏùÑ ÏûàÏñ¥Ïöî</span>", "<span class='korean'>ÏßëÏùÄ ÏÇ¨Îûå ÏóÜÏñ¥Ïöî</span>", "<span class='korean'>Ï†ÄÎäî ÌöåÏÇ¨Ïóê ÏùºÌï¥Ïöî</span>", "<span class='korean'>Ï†ÄÎäî ÎèÑÏÑúÍ¥ÄÏóê ÏûàÏñ¥Ïöî</span>"], answer: 3 },
      { question: "Answer the following question: ‚Äú<span class='korean ko-size'>Ïù¥Í≤å Î≠êÏòàÏöî</span>?‚Äù", options: ["<span class='korean'>Ï±ÖÏù¥ÏóêÏöî</span>", "<span class='korean'>Í∞êÏÇ¨Ìï©ÎãàÎã§</span>", "<span class='korean'>ÎÑ§, ÎßûÏïÑÏöî</span>", "<span class='korean'>Í¥úÏ∞ÆÏïÑÏöî</span>"], answer: 0 },
      { question: "How do you say ‚ÄúI want to watch a movie‚Äù?", options: ["<span class='korean'>ÏòÅÌôîÎ•º Î¥êÏöî</span>", "<span class='korean'>ÏòÅÌôî Î≥¥Í≥† Ïã∂Ïñ¥Ïöî</span>", "<span class='korean'>ÏòÅÌôî Î¥§Ïñ¥Ïöî</span>", "<span class='korean'>ÏòÅÌôî Î≥º Í±∞ÏòàÏöî</span>"], answer: 1 },
      { question: "What is the intention of the following sentence:<br>‚Äú<span class='korean ko-size'>Ï£ºÏä§ Îëê Ïûî Ï£ºÏÑ∏Ïöî</span>‚Äù", options: ["Inviting", "Complimenting", "Ordering", "Apologizing"], answer: 2 }
    ],
    A2: [ {question: "Which sentence means ‚ÄúIt‚Äôs good but expensive‚Äù?", options: ["<span class='korean'>Ï¢ãÏßÄÎßå ÎπÑÏã∏Ïöî</span>", "<span class='korean'>Ï¢ãÏïÑÏÑú ÎπÑÏã∏Ïöî</span>", "<span class='korean'>Ï¢ãÏúºÎ©¥ ÎπÑÏã∏Ïöî</span>", "<span class='korean'>Ï¢ãÍ≥† ÎπÑÏã∏Ïöî</span>"], answer: 0},
          {question: "Choose the word that means ‚ÄúTuesday.‚Äù", options: ["<span class='korean'>Í∏àÏöîÏùº</span>", "<span class='korean'>ÌôîÏöîÏùº</span>", "<span class='korean'>Î™©ÏöîÏùº</span>", "<span class='korean'>ÏõîÏöîÏùº</span>"], answer: 1},
          {question: "Choose the sentence with the correct past tense form.", options: ["<span class='korean'>Ïö¥ÎèôÌñàÏñ¥Ïöî</span>", "<span class='korean'>Ïö¥ÎèôÌïòÍ≥† ÏûàÏñ¥Ïöî</span>", "<span class='korean'>Ïö¥ÎèôÌï¥Ïöî</span>", "<span class='korean'>Ïö¥ÎèôÌï† Í±∞ÏòàÏöî</span>"], answer: 0},
          {question: "Which phrase means ‚Äúthe person who dances/who is dancing‚Äù?", options: ["<span class='korean'>Ï∂§ÏùÑ Ï∂îÍ≥† ÏÇ¨Îûå</span>", "<span class='korean'>Ï∂§ÏùÑ Ï∂∞ ÏÇ¨Îûå</span>", "<span class='korean'>Ï∂§ÏùÑ Ï∂îÎäî ÏÇ¨Îûå</span>", "<span class='korean'>Ï∂§ÏùÑ Ï∂ú ÏÇ¨Îûå</span>"], answer: 2},
          {question: "What is the meaning of ‚Äú<span class='korean ko-size'>Í∞ÄÏßÄ ÎßàÏÑ∏Ïöî</span>‚Äù?", options: ["I'm going", "Please go", "You have to go", "Don't go"], answer: 3},
          {question: "What does ‚Äú<span class='korean ko-size'>Í≥µÎ∂ÄÌï¥Ïïº Ìï¥Ïöî</span>‚Äù mean?", options: ["I have to study", "I plan to study", "I am studying", "I want to study"], answer: 0},
    ], 
    B1: [ {question: "What does ‚Äú<span class='korean ko-size'>ÌïúÍµ≠Ïóê Í∞Ä Î≥∏ Ï†Å ÏûàÏñ¥Ïöî</span>‚Äù mean?", options: ["I want to go to Korea", "I often go to Korea", "I‚Äôve been to Korea", "I will go to Korea"], answer: 2},
          {question: "Choose the sentence that expresses intention.", options: ["<span class='korean'>Î®πÏúºÎ†§Í≥† Ìï¥Ïöî</span>", "<span class='korean'>Î®πÎäî Ï§ëÏù¥ÏóêÏöî</span>", "<span class='korean'>Î®πÍ≥† ÏûàÏñ¥Ïöî</span>", "<span class='korean'>Î®πÏóàÏñ¥Ïöî</span>"], answer: 0},
          {question: "What does ‚Äú<span class='korean ko-size'>Ïö¥ÎèôÌï† Îïå ÏùåÏïÖÏùÑ Îì§Ïñ¥Ïöî</span>‚Äù mean?", options: ["I listen to music before exercising", "I want to exercise and listen to music", "I exercise after I listen to music", "I listen to music when I exercise"], answer: 3},
          {question: "What does ‚Äú<span class='korean ko-size'>ÌïúÍµ≠Ïñ¥Î•º Í≥µÎ∂ÄÌïòÍ≤å ÎêòÏóàÏñ¥Ïöî</span>‚Äù imply?", options: ["I want to study Korean", "I studied Korean before", "I ended up studying Korean", "I can study Korean"], answer: 2},
          {question: "How would you say 'Because I was tired, I slept' in Korean?", options: ["<span class='korean'>ÌîºÍ≥§Ìïú Îã§ÏùåÏóê Ïû§Ïñ¥Ïöî</span>", "<span class='korean'>ÌîºÍ≥§ÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Ïû§Ïñ¥Ïöî</span>", "<span class='korean'>ÌîºÍ≥§Ìï† Îïå Ïû§Ïñ¥Ïöî</span>", "<span class='korean'>ÌîºÍ≥§ÌïòÏßÄÎßå Ïû§Ïñ¥Ïöî</span>"], answer: 1},
          {question: "How do you read ‚Äú<span class='korean ko-size'>7Ïãú 26Î∂Ñ</span>‚Äù in Korean?", options: ["<span class='korean'>Ïπ†Ïãú Ïù¥Ïã≠Ïú°Î∂Ñ</span>", "<span class='korean'>ÏùºÍ≥±Ïãú Ïä§Î¨ºÏó¨ÏÑØÎ∂Ñ</span>", "<span class='korean'>ÏùºÍ≥±Ïãú Ïù¥Ïã≠Ïú°Î∂Ñ</span>", "<span class='korean'>Ïπ†Ïãú Ïä§Î¨ºÏó¨ÏÑØÎ∂Ñ</span>"], answer: 1},
    ],
    B2: [ {question: "Which sentence uses a passive verb?", options: ["<span class='korean'>Î¨∏ÏùÑ Ïó¥ÏóàÏñ¥Ïöî</span>", "<span class='korean'>Î¨∏Ïù¥ Ïó¥Î†∏Ïñ¥Ïöî</span>", "<span class='korean'>Î¨∏ÏùÑ Ïó¥Í≤å ÌñàÏñ¥Ïöî</span>", "<span class='korean'>Î¨∏ÏùÑ Ïó¥Ïñ¥Î≤ÑÎ†∏Ïñ¥Ïöî</span>"], answer: 1},
          {question: "What does ‚Äú<span class='korean ko-size'>ÎπÑÍ∞Ä Ïò§ÎÇò Î¥êÏöî</span>‚Äù express?", options: ["I hope it rains", "It will rain", "I guess it‚Äôs raining", "I see the rain coming"], answer: 2},
          {question: "Choose the sentence that means<br>‚ÄúI called you as soon as I arrived.‚Äù", options: ["<span class='korean'>ÎèÑÏ∞©ÌïòÏûêÎßàÏûê Ï†ÑÌôîÌñàÏñ¥Ïöî</span>", "<span class='korean'>ÎèÑÏ∞©ÌïòÎäêÎùºÍ≥† Ï†ÑÌôîÌñàÏñ¥Ïöî</span>", "<span class='korean'>ÎèÑÏ∞©ÌïòÍ≥† ÎÇòÏÑú Ï†ÑÌôîÌñàÏñ¥Ïöî</span>", "<span class='korean'>Ï†ÑÌôîÌñàÎçîÎãà ÎèÑÏ∞©ÌñàÏñ¥Ïöî</span>"], answer: 0},
          {question: "What does ‚Äú<span class='korean ko-size'>Ïù¥ Ï±ÖÏùÄ ÏùΩÏùÑ ÎßåÌï¥Ïöî</span>‚Äù mean?", options: ["This book is readable", "This book is difficult to read", "This book is easy to read", "This book is not worth reading"], answer: 0},
          {question: "Which of the following uses indirect quotation correctly?", options: ["<span class='korean'>Í∑∏Îäî ÎÇ¥Ïùº Ïò§ÎÇò Î¥êÏöî</span>", "<span class='korean'>Í∑∏Îäî ÎÇ¥Ïùº Ïò¨ Í±∞ÏòàÏöî</span>", "<span class='korean'>Í∑∏Îäî ÎÇ¥Ïùº Ïò§Í∏∞Îäî Ìï¥Ïöî</span>", "<span class='korean'>Í∑∏Îäî ÎÇ¥Ïùº Ïò®Îã§Í≥† ÌñàÏñ¥Ïöî</span>"], answer: 3},
          {question: "Which sentence uses honorific form correctly?", options: ["<span class='korean'>ÏÑ†ÏÉùÎãòÍªòÏÑú Î∞•ÏùÑ Î®πÏñ¥Ïöî</span>", "<span class='korean'>ÏÇ¨Ïû•ÎãòÍªòÏÑú ÌöåÏÇ¨Ïóê ÏûàÏñ¥Ïöî</span>", "<span class='korean'>Ìï†Î®∏ÎãàÍªòÏÑú Ï£ºÎ¨¥ÏÑ∏Ïöî</span>", "<span class='korean'>ÏïÑÎ≤ÑÏßÄÍªòÏÑú ÎßêÌï¥Ïöî</span>"], answer: 2}
    ],
    C1: [ {question: "What does ‚Äú<span class='korean ko-size'>ÏÇ¨ÎûåÏùÄ ÎàÑÍµ¨ÎÇò Ïã§ÏàòÌïòÍ∏∞ ÎßàÎ†®Ïù¥ÏóêÏöî</span>‚Äù mean?", options: ["Everyone always tries not to make mistakes", "Everyone is bound to make mistakes", "Everyone never makes mistakes", "Everyone easily makes mistakes"], answer: 1},
          {question: "What is the meaning of ‚Äú<span class='korean ko-size'>Í∑∏Îäî ÏßÄÍ∏àÏØ§ ÎèÑÏ∞©ÌñàÏùÑÏßÄÎèÑ Î™∞ÎùºÏöî</span>‚Äù?", options: ["He has definitely arrived by now", "He is probably arriving soon", "He might have arrived by now", "He won‚Äôt arrive"], answer: 2},
          {question: "Which sentence expresses regret or unintended consequence?", options: ["<span class='korean'>Ïö∏Í≤å ÎêêÏñ¥Ïöî</span>", "<span class='korean'>Ïö∏Í∏∞ ÎßàÎ†®Ïù¥ÏóêÏöî</span>", "<span class='korean'>Ïö∏ÏóàÏùÑÏßÄÎèÑ Î™∞ÎùºÏöî</span>", "<span class='korean'>Ïö∏Í≥† ÎßêÏïòÏñ¥Ïöî</span>"], answer: 3},
          {question: "What is the meaning of ‚Äú<span class='korean ko-size'>ÎÇ©ÎìùÌïòÎã§</span>‚Äù?", options: ["To insist strongly", "To persuade others", "To understand and accept", "To argue against"], answer: 2},
          {question: "Choose a word to fill in the blank:<br><span class='korean ko-size'>ÏÉÅÎåÄÎ∞©Ïùò ÏûÖÏû•ÏùÑ Í≥†Î†§ÌïòÏßÄ ÏïäÎäî Î∞úÏñ∏ÏùÄ Ïò§ÌûàÎ†§ Í∞àÎì±ÏùÑ _______ Ïàò ÏûàÎã§.</span>", options: ["<span class='korean'>ÏïºÍ∏∞Ìï†</span>", "<span class='korean'>ÌöåÌîºÌï†</span>", "<span class='korean'>ÏôÑÌôîÌï†</span>", "<span class='korean'>Í∞ïÏ°∞Ìï†</span>"], answer: 0},
          {question: "Which sentence sounds the most semantically natural?", options: ["<span class='korean'>Í∑∏Îäî Î∞•ÏùÑ Î®πÍ∏∞Îäî Ïª§ÎÖï Îëê Í∑∏Î¶áÏù¥ÎÇò ÎπÑÏõ†Ïñ¥Ïöî</span>", "<span class='korean'>Í∑∏Îäî Ï°∏ÏóÖÌïòÎã§ÏãúÌîº Í≥µÎ∂ÄÎ•º ÏãúÏûëÌñàÎã§</span>", "<span class='korean'>Ï¢Ä Îçî ÏùºÏ∞ç ÎèÑÏ∞©ÌñàÎçîÎùºÎ©¥ ÎπÑÌñâÍ∏∞Î•º ÎÜìÏ≥§ÏùÑ Í±∞ÏòàÏöî</span>", "<span class='korean'>Í∑∏Î†áÍ≤å ÎààÏπò Î≥¥Î©¥ÏÑú ÏùºÌïòÎäêÎãà Ï∞®ÎùºÎ¶¨ Îã§Î•∏ ÏßÅÏû•ÏùÑ Íµ¨ÌïòÎäî Í≤å ÎÇ´Í≤†Ïñ¥Ïöî</span>"], answer: 3}
    ],
  };

  runPlacementStep(testState, PL_LEVELS, questions);
}

function runPlacementStep(state, levels, questions) {
  saveAppState("placementTest", { testState: { ...state } });
  const level = levels[state.currentLevelIndex];
  const currentQuestionSet = questions[level];
  const frameBox = document.querySelector(".frame-box");

  // ÌÖåÏä§Ìä∏ Ï¢ÖÎ£å Ï°∞Í±¥
if (!currentQuestionSet || state.questionIndex >= currentQuestionSet.length) {
  const passed = state.correctCount >= 4; // 4Í∞ú Ïù¥ÏÉÅ ÎßûÏ∂∞Ïïº Îã§Ïùå Î†àÎ≤®Î°ú
  if (passed && state.currentLevelIndex < levels.length - 1) {
    // Îã§Ïùå Î†àÎ≤®Î°ú
    state.currentLevelIndex++;
    state.correctCount = 0;
    state.questionIndex = 0;
    return runPlacementStep(state, levels, questions); // ‚òÖ Ïó¨Í∏∞Ïóê return Ï∂îÍ∞Ä
  } else {
    // Ï¢ÖÎ£å ‚Üí Í≤∞Í≥º Î≥¥Ïó¨Ï£ºÍ∏∞
    const recommendedLevel = passed ? levels[state.currentLevelIndex] : levels[state.currentLevelIndex - 1] || "A1";
    showPlacementResult(recommendedLevel);
    return;
  }
}

  // ÌòÑÏû¨ ÏßàÎ¨∏ Ï∂úÎ†•
  const q = currentQuestionSet[state.questionIndex];
  frameBox.innerHTML = `
  <div class="question-p">
    <h2 class="question-number">Question ${state.globalIndex + 1}</h2>
    <p class="question-text">${q.question}</p>
    <div class="level-buttons">
      ${q.options.map((opt, i) => `<button class="btn option" data-index="${i}">${opt}</button>`).join("")}
    </div>
  </div>
  `;

  document.querySelectorAll(".option").forEach(btn => {
    btn.addEventListener("click", () => {
      const selected = Number(btn.getAttribute("data-index"));
      if (selected === q.answer) state.correctCount++;
      state.questionIndex++;
      state.globalIndex++;
      runPlacementStep(state, levels, questions);
    });
  });
}

function showPlacementResult(level) {
  saveAppState("placementResult", { recommendedLevel: level });
  const frameBox = document.querySelector(".frame-box");
  frameBox.innerHTML = `
    <h2 class="lvl-h">Your Level is ${level}üéâ</h2>
    <p class="description lvl-re">We recommend you start at <strong>${level}</strong> level. Let‚Äôs begin your journey!</p>
    <div class="buttons">
      <button class="btn" id="startAtLevel">Start at this level</button>
    </div>
  `;

  document.getElementById("startAtLevel").addEventListener("click", () => {
    localStorage.setItem("level", level);
    showMainAppScreen();
  });
}

document.addEventListener("click", (e) => {
  if (e.target && e.target.classList.contains("test")) {
    showPlacementIntro();
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("starCanvas");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let stars = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    createStars(60);
  }

  function createStars(count) {
    stars = [];
    for (let i = 0; i < count; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 4 + 4,
        opacity: Math.random(),
        speed: Math.random() * 0.015 + 0.005,
        direction: Math.random() > 0.5 ? 1 : -1,
      });
    }
  }

  function drawStar(star) {
    ctx.save();
    ctx.globalAlpha = star.opacity;
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(star.x - star.r, star.y);
    ctx.lineTo(star.x + star.r, star.y);
    ctx.moveTo(star.x, star.y - star.r);
    ctx.lineTo(star.x, star.y + star.r);
    ctx.stroke();

    ctx.restore();
  }

  function animateStars() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(star => {
      star.opacity += star.speed * star.direction;
      if (star.opacity >= 1 || star.opacity <= 0) {
        star.direction *= -1;
      }
      drawStar(star);
    });
    requestAnimationFrame(animateStars);
  }

  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();
  animateStars();
});

function mountButterflies() {
  const frame = document.querySelector('.frame-box');
  if (!frame) return;

  // Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ: frame-box ÏïàÎßå ÌôïÏù∏
  if (frame.querySelector('.butterfly-wrapper')) return;

  const left = document.createElement('div');
  left.className = 'butterfly-wrapper';
  left.innerHTML = '<div class="butterfly"></div>';

  const right = document.createElement('div');
  right.className = 'butterfly-wrapper right';
  right.innerHTML = '<div class="butterfly right"></div>';

  frame.appendChild(left);
  frame.appendChild(right);
}

// --- ÏÉÅÌÉú Ï†ÄÏû•Ïö© Ïú†Ìã∏ ---
function saveAppState(page, extra = {}) {
  localStorage.setItem("appState", JSON.stringify({ page, ...extra }));
}

function loadAppState() {
  try {
    return JSON.parse(localStorage.getItem("appState")) || {};
  } catch {
    return {};
  }
}

function openMyCornerPanel() {
  const tabContent = document.getElementById("tabContent");
  if (!tabContent) return;

  tabContent.innerHTML = `
    <div class="main-header-flex">
      <div class="level-indicator">Level ${localStorage.getItem("level")}</div>
      <h2 class="hi">My Corner ‚Äî Sync</h2>
    </div>
    <p class="description">Save and load your data, using Google Drive</p>

    <div class="buttons" style="margin-top:1rem;">
      <button class="btn" id="driveSave">Save to Google Drive</button>
      <button class="btn secondary" id="driveLoad">Load from Google Drive</button>
      <button class="btn" id="driveDisconnect">Disconnect</button>
    </div>
  `;

  // Ìï∏Îì§Îü¨Îì§
  document.getElementById("driveSave")?.addEventListener("click", async () => {
    try {
      const payload = {
        username: localStorage.getItem("username"),
        level: localStorage.getItem("level"),
        appState: JSON.parse(localStorage.getItem("appState") || "{}"),
        updatedAt: new Date().toISOString()
      };
      await driveSaveState(payload);
      alert("Saved successfully!");
    } catch (e) {
      console.error(e);
      alert("Failed to save due to an error!");
    }
  });

  document.getElementById("driveLoad")?.addEventListener("click", async () => {
    try {
      const data = await driveLoadState();
      if (data.username) localStorage.setItem("username", data.username);
      if (data.level) localStorage.setItem("level", data.level);
      if (data.appState) localStorage.setItem("appState", JSON.stringify(data.appState));
      alert("Loaded successfully!");
      const name = localStorage.getItem("username");
      const level = localStorage.getItem("level");
      if (level) return showMainAppScreen();
      if (name) return showLevelSelection();
      return renderNameInput();
    } catch (e) {
      console.error(e);
      alert("Failed to load due to an error!");
    }
  });

  document.getElementById("driveDisconnect")?.addEventListener("click", () => {
    driveSignOut();
    alert("Disconnected from Google!");
  });

  document.getElementById("backToHome")?.addEventListener("click", () => {
    // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÌÉ≠ÏúºÎ°ú Î≥µÍ∑Ä
    const s = (loadAppState().tab) || "Home";
    updateTabContent(s);
  });
}
